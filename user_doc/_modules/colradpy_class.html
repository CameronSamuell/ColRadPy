
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>colradpy_class &#8212; ColRadPy 0.9 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ColRadPy 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for colradpy_class</h1><div class="highlight"><pre>
<span></span><span class="c1">################################################################################</span>
<span class="c1"># file name         : colrad.py</span>
<span class="c1"># author            : Curt Johnson</span>
<span class="c1"># description       : This code solves the collsion radiative matrix</span>
<span class="c1"># version           : 0.3</span>
<span class="c1"># python version    : Python 3.6.5 ipython 6.4.0 anaconda</span>
<span class="c1"># dependencies      : read_adf04_py3_class.py, numpy, scipy interpolate,</span>
<span class="c1">#                   : matplotlib, re, sys, r8yip, r8necip, ecip_rates</span>
<span class="c1">#                   : burgess_tully_rates, collections</span>
<span class="c1"># license           : to be freed after code is stable and papers are published</span>
<span class="c1">#</span>
<span class="c1"># This code originally went through different file names and versions that</span>
<span class="c1"># incorprated different functionalitiy before it was under version control.</span>
<span class="c1"># These are included in the repos for historical and bug tracking reasons.</span>
<span class="c1"># The order went adf04_read.py, adf04_read1.py, adf04_dens_grid.py,</span>
<span class="c1"># adf04_dens_temp_grid_tmp.py, colrad.py</span>
<span class="c1"># </span>
<span class="c1"># The code solves the colisional radiative problem see Stuart loch&#39;s </span>
<span class="c1"># spectroscopy class notes or Curt Johnson&#39;s upcoming thesis for a derivation</span>
<span class="c1"># of the CR matrix.</span>
<span class="c1">#</span>
<span class="c1"># The read_adf04.py will read adf04 files and produces the dictionary with data</span>
<span class="c1"># Takes a density array, temperature array, metastable number, </span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">################################################################################</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">r8yip</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">r8necip</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">read_adf04_py3_class</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ecip_rates</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">burgess_tully_rates</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">split_multiplet</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">solve_matrix_exponential</span> <span class="k">import</span> <span class="o">*</span>

<div class="viewcode-block" id="convert_to_air"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.convert_to_air">[docs]</a><span class="k">def</span> <span class="nf">convert_to_air</span><span class="p">(</span><span class="n">lam</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function converts the vacuum wavelength of spectral lines to </span>
<span class="sd">       the air wavelength. The wavelength is the difference in energy</span>
<span class="sd">       levels of the upper and lower transition. By defualt in the adf04</span>
<span class="sd">       file these energy correspond to the vacuum wavelengths to this</span>
<span class="sd">       must be converted at some point for UV and visible light.</span>

<span class="sd">    :param lam: The wavelengths in nm in vacuum</span>
<span class="sd">    :type lam: array</span>

<span class="sd">    :returns: array --wavelengths in nm in air</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">lam</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.0000834254</span> <span class="o">+</span> <span class="mf">0.02406147</span> <span class="o">/</span> <span class="p">(</span><span class="mi">130</span> <span class="o">-</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.00015998</span> <span class="o">/</span> <span class="p">(</span><span class="mf">38.9</span> <span class="o">-</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="colradpy"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy">[docs]</a><span class="k">class</span> <span class="nc">colradpy</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;The ColRadPy class, this class will store data and carry out calculation to solve</span>
<span class="sd">       the collisional radiative set of equations. A full tutorial is provided in the </span>
<span class="sd">       documentation.</span>
<span class="sd">   </span>
<span class="sd">    Args:</span>
<span class="sd">      :param fil: the file path to the input file</span>
<span class="sd">      :type fil: string</span>

<span class="sd">      :param metas: array of the levels that metastable</span>
<span class="sd">      :type metas: integer array</span>

<span class="sd">      :param temp_grid: array of temperature for calculation (eV)</span>
<span class="sd">      :type metas: float array</span>

<span class="sd">      :param dens_grid: array of temperature for calculation (cm-3)</span>
<span class="sd">      :type metas: float array</span>

<span class="sd">      :param use_ionization: Flag to turn on ionization in calculation, default = True</span>
<span class="sd">      :type metas: bool</span>

<span class="sd">      :param suppliment_with_ecip: Flag to turn on ECIP supplimentation to ionization rates, default = Tue</span>
<span class="sd">      :type metas: bool</span>

<span class="sd">      :param use_recombination_three_body: Flag to turn 3 body recombination on,  default = True</span>
<span class="sd">      :type metas: bool</span>

<span class="sd">      :param use_recombination: Flag to turn recombination on, default = True</span>
<span class="sd">      :type metas: bool</span>

<span class="sd">      :param td_t: Time array for time dependent solution to CR equations</span>
<span class="sd">      :type metas: float array</span>

<span class="sd">      :param td_n0: Initial populations of levels at time t=0 for TD CR equations</span>
<span class="sd">      :type metas: float array</span>

<span class="sd">      :param td_source: source term for populations in the TD CR equations</span>
<span class="sd">      :type metas: float array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fil</span><span class="p">,</span><span class="n">metas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">temp_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">electron_den</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                 <span class="n">use_ionization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suppliment_with_ecip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">use_recombination_three_body</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">use_recombination</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">td_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">td_n0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">td_source</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                  <span class="n">default_pop_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The initializing method. Sets up the nested list for data storage and starts to populate with user data</span>
<span class="sd">           as well as reading in the adf04 file</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temp_grid</span><span class="p">)</span> <span class="c1">#eV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">electron_den</span><span class="p">)</span><span class="c1">#cm-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_ionization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_ionization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;suppliment_with_ecip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suppliment_with_ecip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_recombination_three_body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_recombination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;look at [atomic][metas] for values&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">td_t</span><span class="p">)</span><span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_n0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">td_n0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">td_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;default_pop_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_pop_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_data</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">metas</span><span class="p">)</span>

<div class="viewcode-block" id="colradpy.update_dict"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.update_dict">[docs]</a>    <span class="k">def</span> <span class="nf">update_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will update dictionary that is stores all parameter for the class</span>

<span class="sd">        :param d: the dictionary that is to be updated</span>
<span class="sd">        :type d: dictionary</span>

<span class="sd">        :param w: the dictionary the use wants to update to</span>
<span class="sd">        :type w: dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="colradpy.populate_data"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.populate_data">[docs]</a>    <span class="k">def</span> <span class="nf">populate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fil</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will populate atomic data. Currently this only uses the</span>
<span class="sd">           adf04 file but there is nothing special about this format and should be</span>
<span class="sd">           put out to pasture at some point</span>

<span class="sd">        :param fil: path to the file that contains atomic data</span>
<span class="sd">        :type fil: file path</span>

<span class="sd">        :returns: array --wavelengths in nm in air</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">read_adf04</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;file_loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fil</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">fil</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fil</span></div>

<div class="viewcode-block" id="colradpy.make_ecip"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_ecip">[docs]</a>    <span class="k">def</span> <span class="nf">make_ecip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function calls the ecip_rates function and populates the ecip</span>
<span class="sd">           values in the dictionary. See documentation ecip_rates.py for a better desciption</span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ecip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        <span class="c1">#there was a stupid problem beacuse {X} only designates ecip not other ionization</span>
        
        <span class="c1">#2/28/18 In solving this problem I introduced another problem. The code was using the {X}</span>
        <span class="c1">#for levels that are also over the ionizaton potential. and then there wasn&#39;t a check</span>
        <span class="c1">#so ECIP was made for levels above ionization potential which it should be.</span>


        <span class="n">inds_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ecip&#39;</span><span class="p">][</span><span class="n">inds_below</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecip_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="n">inds_below</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;zpla&#39;</span><span class="p">][</span><span class="n">inds_below</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;zpla1&#39;</span><span class="p">][</span><span class="n">inds_below</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;charge_state&#39;</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span></div>
        
<div class="viewcode-block" id="colradpy.make_burgess_tully"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_burgess_tully">[docs]</a>    <span class="k">def</span> <span class="nf">make_burgess_tully</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function calls the burgess_tully_rates function and updates the &#39;rates&#39; dictionary</span>

<span class="sd">           values in the dictionary. See documentation ecip_rates.py for a better desciption</span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">burgess_tully_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">]</span>\
                                                       <span class="p">[</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit&#39;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;a_val&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;inf_engy&#39;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="colradpy.make_ioniz_from_reduced_ionizrates"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_ioniz_from_reduced_ionizrates">[docs]</a>    <span class="k">def</span> <span class="nf">make_ioniz_from_reduced_ionizrates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This function calls will make ionization rates to be used in the CR matrix from the</span>
<span class="sd">           reduced ionization rates that are provided in the adf04 file. This function</span>
<span class="sd">           must be called even if ionization is not provided so that ECIP rates can be </span>
<span class="sd">           supplimented into the matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="c1">#if there is no ionization in the file create a zero matrix so that ECIP can be subbed in</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ion_excit&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No ionization in the input file ECIP can be made&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
            <span class="k">return</span>

        <span class="c1">#changed 4/19/17 to allow mutliple ion metas        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>

        <span class="n">ion_excit_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ion_excit&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;slinear&#39;</span><span class="p">)</span>
        
        <span class="n">ion_excit_interp_grid</span> <span class="o">=</span> <span class="n">ion_excit_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ion_transitions&#39;</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s1">&#39;ion_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s1">&#39;ion_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion_excit_interp_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s1">&#39;ion_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>\
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ion_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="p">])</span>\
                    <span class="o">*</span><span class="mf">0.00012398774011749576</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span></div>
<div class="viewcode-block" id="colradpy.suppliment_with_ecip"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.suppliment_with_ecip">[docs]</a>    <span class="k">def</span> <span class="nf">suppliment_with_ecip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will suppliment the ionization that is to be used in the CR matrix</span>
<span class="sd">           with ECIP ionization if there is no ionization that is provided. While ECIP ionization</span>
<span class="sd">           is better than not including ionization using other ionization rates is generall better</span>
<span class="sd">           Ionization must be must be included to accurately model plasma even if it is approximate ECIP</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;ecip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ECIP was not previously calculated, calculating now&quot;</span><span class="o">+</span>\
                   <span class="s2">&quot; from inside &#39;suppliment_with_ecip&#39;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_ecip</span><span class="p">()</span>

        <span class="k">if</span><span class="p">((</span><span class="s1">&#39;ionization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_ionization&#39;</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No ionization rates from files were calculated,&#39;</span><span class="o">+</span>\
                  <span class="s1">&#39; try to calculate them&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_ioniz_from_reduced_ionizrates</span><span class="p">()</span>

        <span class="c1">#added for the case that ionization is turned off and </span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;ionization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])):</span>
            <span class="c1">#there was a stupid problem beacuse {X} only designates ecip not other ionization   </span>
            <span class="n">ion_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;zpla&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ion_inds2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;zpla1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span> <span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ion_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ion_inds</span><span class="p">,</span><span class="n">ion_inds2</span><span class="p">)</span>
            <span class="n">ecip_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">to_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ecip_inds</span><span class="p">,</span><span class="n">ion_inds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="n">to_use</span><span class="p">,</span><span class="n">p</span><span class="p">,:]</span> <span class="o">=</span>\
                                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ecip&#39;</span><span class="p">][</span><span class="n">to_use</span><span class="p">,</span><span class="n">p</span><span class="p">,:]</span></div>

<div class="viewcode-block" id="colradpy.make_recombination_rates_from_file"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_recombination_rates_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_recombination_rates_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will make recombination rates from the rates that are provided in the</span>
<span class="sd">           adf04 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">recomb_excit_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit&#39;</span><span class="p">],</span>
                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;slinear&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit_interp_grid&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                    <span class="n">recomb_excit_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span>
        <span class="c1">#replace values lower than 1e-30 with a linear interpolation</span>
        <span class="c1">#because slinear gives the the wrong answer for some reason</span>
        <span class="c1">#maybe dont need this part now, 1dinterp was using kind=&#39;slinear&#39;</span>
        <span class="c1">#changed now and hopefully wont get the errors</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit&#39;</span><span class="p">]</span>\
                                   <span class="o">&lt;</span><span class="mf">1.e-30</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span> <span class="o">&lt;</span>\
                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">c</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">,</span>\
                                 <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">c</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>\
                                 <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;slinear&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit_interp_grid&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">c</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>\
                                                    <span class="n">w</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_transitions&#39;</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">]</span>\
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_transitions&#39;</span><span class="p">][</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_transitions&#39;</span><span class="p">][</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit_interp_grid&#39;</span><span class="p">][</span><span class="n">q</span><span class="p">]</span></div>

<div class="viewcode-block" id="colradpy.make_three_body_recombination"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_three_body_recombination">[docs]</a>    <span class="k">def</span> <span class="nf">make_three_body_recombination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will make three body recombination rates by using a detailed balance</span>
<span class="sd">           relation with ionization that used. Three body recombination becomes important at high densities</span>
<span class="sd">           and low temperatures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#from the los alimos lab manual</span>
        <span class="c1">#he[&#39;w&#39;] = (he[&#39;S&#39;]*(he[&#39;L&#39;]*2+1)-1)/2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])):</span>
            <span class="n">l_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_term&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">])</span> <span class="o">==</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># was -1)/2.</span>
                <span class="n">w_ion</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_term&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> \
                          <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l_map</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_term&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_term&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">])</span> <span class="o">==</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">w_ion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_term&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w_ion</span><span class="o">=</span><span class="mf">1e30</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;w_ion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_ion</span><span class="c1">#1.656742E-22</span>
            <span class="c1">#this is from detailed balance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">1.656742E-22</span><span class="o">*</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span> \
                <span class="n">w_ion</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="o">-</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.000123985</span><span class="p">))</span> <span class="o">*</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:]</span> <span class="o">/</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span></div>
        <span class="c1">#rates of this are in cm3</span>

<div class="viewcode-block" id="colradpy.make_electron_excitation_rates"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.make_electron_excitation_rates">[docs]</a>    <span class="k">def</span> <span class="nf">make_electron_excitation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This function will make both electron impact excitation and deexcitation rates</span>
<span class="sd">           from the values that stored in adf04 file on a user defined temperature grid</span>
<span class="sd">           If values are above the last calculate point in the adf04 then a burgess tully</span>
<span class="sd">           extrapolation will be used. There is currently no extrapolation below the first</span>
<span class="sd">           calculated temperature point. THis is something to add in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">11604.5</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;slinear&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit&#39;</span><span class="p">]),</span>
                                                                         <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>


        <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="s1">&#39;burg_tully&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">]</span>\
                                <span class="p">[</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">11604.5</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span> <span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Atleast one user temp pont above last calculated temperature using extrapolation be carefull&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_burgess_tully</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_file&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">11604.5</span> <span class="o">&lt;</span> \
           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])):</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;extrap_temp_inds&#39;</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">]</span>\
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;ind_arrs&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;extrap_temp_inds&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span>\
                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;excit_extrap&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;zero_inds&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">]</span>\
                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;ind_arrs&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>\
                                           <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;zero_inds&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;extrap_temp_inds&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span>\
                                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;excit_extrap_lin&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">]</span>\
                                   <span class="p">[</span><span class="s1">&#39;interp_temp_inds&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="n">tmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;burg_tully&#39;</span><span class="p">][</span><span class="s1">&#39;interp_temp_inds&#39;</span><span class="p">]])</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="colradpy.populate_cr_matrix"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.populate_cr_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">populate_cr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will populate the collision radiative matrix with all the rates that</span>
<span class="sd">           user asks to be included into the calculation.</span>

<span class="sd">           Ionization is included from the ADF04 file, there is a user option to suppliment with ECIP</span>
<span class="sd">           rates that ColRadPy will make</span>

<span class="sd">           Recombination is included from the ADF04 file.</span>
<span class="sd">           Three-body recombination can also be made from ColRadPy through detailed balance</span>
<span class="sd">           Excitation rates are included from the ADF04 file.</span>

<span class="sd">           The dictionary [&#39;cr_matrix&#39;] is made in this definition mostly from rates in the [&#39;rates&#39;] dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#add in the excitation/de-excitation if they are not already calculated</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;col_excit_interp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electron collisional rates have not yet been made on &#39;</span><span class="o">+</span>\
                  <span class="s1">&#39;the user defined temperature grid. Doing that now&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_electron_excitation_rates</span><span class="p">()</span>
        <span class="c1">#add in ecip ionization if not already included</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;ecip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;suppliment_with_ecip&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suppliment_with_ecip</span><span class="p">()</span>
        <span class="c1">#add in ionization if it was not already included</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;ionization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                               <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_ionization&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_ioniz_from_reduced_ionizrates</span><span class="p">()</span>
        <span class="c1">#add in threebody recombination if it was not already included</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                 <span class="s1">&#39;recomb_three_body&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Three body recombination was not previously calculated. Doing that now&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_three_body_recombination</span><span class="p">()</span>
        <span class="c1">#add in recombination if present and it was not already calculated</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_excit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> \
                       <span class="s1">&#39;recomb_excit_interp_grid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recombination from file was not previously calculated. Doing that now&#39;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">make_recombination_rates_from_file</span><span class="p">()</span>

        
            
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">])):</span>
            <span class="c1"># the if statement here is to account for files that have had energies</span>
            <span class="c1"># deleted from the begining of the adf04. It is assumed if those</span>
            <span class="c1"># entries are not at the top of the adf04 file then the user does not</span>
            <span class="c1"># want to included then this allows the matrix to be made ignoring</span>
            <span class="c1"># levels above the levels taken out in the file.</span>
            <span class="k">if</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">])):</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>  \
                    <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">13.6058</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_excit_interp&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">2.1716E-8</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>  \
                    <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span>  \
                    <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span>  \
                    <span class="mf">8.065E3</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;excit&#39;</span><span class="p">][</span><span class="s1">&#39;col_transitions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;a_val&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1">#transpose the self.data[&#39;cr_matrix&#39;][&#39;q_ij&#39;] matrix so the indexes make sense</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        
        <span class="n">nsigmaplus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]):</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_transitions&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]))</span><span class="o">&gt;</span><span class="n">nsigmaplus</span><span class="p">):</span>
               <span class="n">nsigmaplus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_transitions&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="n">nsigmaplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">nsigmaplus</span><span class="p">,</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">nsigmaplus</span><span class="p">,</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">nsigmaplus</span><span class="p">,</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">nsigmaplus</span><span class="p">,</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>


        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])):</span>
            <span class="c1">#level i depopulating mechanisms</span>
            <span class="c1">#these are all the transitions from the level</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span>  <span class="o">=</span>  <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_loss&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span>  <span class="o">=</span>  <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:])</span>
            <span class="c1">#these are all the excitation and dexcitation bringing you out of the level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_loss&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#these are the ways to ionize out of ion</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">-</span> \
                                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_loss&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">-</span> \
                                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#level i populating mechanisms</span>
            <span class="c1">#these are the transition rates from higher levels into the level i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">+</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>

            <span class="c1">#these are excitation and dexciation into the level i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">+</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ij&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;q_ji&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span>
            
        <span class="c1">#recombination out of plus ion to current</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsigmaplus</span><span class="p">):</span>
                <span class="c1">#these are the rates from the plus ion into the current ion levels</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">+</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span>

                <span class="c1">#this is the sum of all the pop lost to the current ion levels taken</span>
                <span class="c1">#out of the plus ion</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#three body recombination out of plus ion to current ion</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsigmaplus</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">+</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,:,:]</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>                
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsigmaplus</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span> <span class="n">p</span><span class="p">,</span>
                                                 <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">=</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">p</span><span class="p">,</span>
                                                         <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:]</span> <span class="o">+</span> \
                               <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,k-&gt;ijk&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][:,</span><span class="n">p</span><span class="p">,:],</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span></div>

                
<div class="viewcode-block" id="colradpy.solve_quasi_static"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.solve_quasi_static">[docs]</a>    <span class="k">def</span> <span class="nf">solve_quasi_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will solve the CR matrix using the quasistatic approximation, after solving this problem</span>
<span class="sd">           the generalized radiative coefficients GCRs will be calculated other claculated quanities such as </span>
<span class="sd">           PEC and SXB are also calculated. This function is analgous to ADAS208.</span>


<span class="sd">           Creates the [&#39;processed&#39;] dictionary which will hold all of the quanties that require the CR</span>
<span class="sd">           matrix to be solved in order to be obtained. </span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;cr_matrix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_cr_matrix</span><span class="p">()</span>
        <span class="n">levels_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">])</span>


        <span class="c1">#[:,0:len(self.data[&#39;atomic&#39;][&#39;metas&#39;]),:,:] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">=</span> \
                                          <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]]</span>
        <span class="n">cr_red</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">][:,</span><span class="n">levels_to_keep</span><span class="p">]</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="c1">#num_recombs = np.shape(self.data[&#39;rates&#39;][&#39;recomb&#39;][&#39;recombination&#39;])[1]</span>
            <span class="n">num_recombs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])</span>
            <span class="n">recomb_driving_lvls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span> <span class="o">+</span> \
                                  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_recombs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num_recombs</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                                            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">][:,</span><span class="n">recomb_driving_lvls</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cr_red</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">cr_red</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cr_red</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_red</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;excited_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">levels_to_keep</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cr_red</span><span class="p">),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cr_red</span><span class="p">),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkl,jnkl-&gt;inkl&#39;</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">],</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
        <span class="c1">#normalization of populations is done here. Quasistatic approximation assumes that</span>
        <span class="c1">#there is a small population in &#39;excited&#39; states, this is sometimes not the case</span>
        <span class="c1">#so the populations must be renomalized the default when there is one metastable</span>
        <span class="c1">#present is to normalize, but there is a choice for the user to decide</span>
        <span class="c1">#default when there is more than one metastable is to not normalize</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;default_pop_norm&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]</span> <span class="o">=</span>\
                          <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">]</span> <span class="o">/</span>\
                                             <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1">#setup pec and wavelength stuff start them as lists because</span>
        <span class="c1">#we wont know which levels actually have pec values before we loop through them</span>
        <span class="c1">#this lists are eventually converted into np arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">levels_to_keep</span><span class="p">)):</span>
                <span class="c1">#if statement here because there will be a number of transitions that have zero</span>
                <span class="c1">#for the PEC value and don&#39;t want to have to keep track of these.</span>
                <span class="k">if</span><span class="p">(</span><span class="n">levels_to_keep</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="p">):</span><span class="c1">#and self.data[&#39;cr_matrix&#39;][&#39;A_ji&#39;][j,i] &gt; 1E-31):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;A_ji&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]</span><span class="o">*</span>\
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">/</span> \
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.e7</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>\
                                                                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">levels_to_keep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">]))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">]</span><span class="o">/</span> \
                                                       <span class="n">convert_to_air</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;acd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;xcd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">]),</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">]),</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="c1">#these are how levels get populated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkl,jmkl-&gt;ijmkl&#39;</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">][:,:,:,:])</span>
        <span class="c1">#population of levels with no normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops_no_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">]</span><span class="o">/</span>   \
                                            <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1">#the F matrix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pop_lvl&#39;</span><span class="p">]</span>\
                                             <span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),:,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#effective ionization rate</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ipk,imkl-&gt;mpkl&#39;</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">,:,:],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;F&#39;</span><span class="p">])</span>

            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;driving_populations_norm&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">+</span> \
                                              <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ipk,ikl-&gt;ipkl&#39;</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],:,:],</span>
                          <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pops_no_norm&#39;</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],:,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span> <span class="o">+</span> \
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],:,:,</span><span class="kc">None</span><span class="p">]</span>


        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="c1">#this is the total recombination with three body and the rates that in included in the adf04 file</span>
            <span class="n">recomb_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,l-&gt;ijkl&#39;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span> <span class="o">+</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">][:,:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]):</span>
            <span class="n">recomb_coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recombination&#39;</span><span class="p">][:,:,:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>            
            <span class="n">recomb_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,l-&gt;ijkl&#39;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">][</span><span class="s1">&#39;recomb_three_body&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="c1">#effective recombination rate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;acd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njkl,jmkl-&gt;nmkl&#39;</span><span class="p">,</span>

                           <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]],</span> <span class="n">levels_to_keep</span><span class="p">,:,:],</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkl,jmkl-&gt;imkl&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                           <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:],</span>
                           <span class="n">recomb_coeff</span><span class="p">[</span><span class="n">levels_to_keep</span><span class="p">,:,:,:])</span>
                           <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;acd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;acd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">recomb_coeff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],:,:,:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;qcd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">])):</span>
            <span class="n">metas_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
            <span class="c1">#calculate the metastable cross coupling coefficent, this the number of atoms that start in one</span>
            <span class="c1">#metastable and then end up in a different metastable</span>
            <span class="n">metas_to_keep_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>\
                                     <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">],</span> <span class="n">metas_to_keep</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;qcd&#39;</span><span class="p">][</span><span class="n">metas_to_keep_ind</span><span class="p">,</span><span class="n">n</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nkl,l-&gt;nkl&#39;</span><span class="p">,</span>
                                                                           
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span><span class="n">metas_to_keep</span><span class="p">,:,:]</span> <span class="o">+</span>\
                                    <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mkl,mnkl-&gt;nkl&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span>
                                    <span class="n">levels_to_keep</span><span class="p">,:,:],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;F&#39;</span><span class="p">][:,</span><span class="n">metas_to_keep_ind</span><span class="p">,:,:]</span>
                                    <span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">])</span>


        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>            
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])):</span>

                <span class="n">metasplus_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">),</span><span class="n">m</span><span class="p">)</span>
                <span class="n">metasplus_to_keep_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>\
                                     <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;ion_pot_lvl&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">metasplus_to_keep</span><span class="p">)]</span>
                <span class="c1">#parent cross coupling coefficient, start in the parent atom, recombine get redistrubted then</span>
                <span class="c1">#ionize back into the parent but into a different parent metastable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;xcd&#39;</span><span class="p">][</span><span class="n">metasplus_to_keep_ind</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">]),:,:]</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ik,imkl-&gt;mkl&#39;</span><span class="p">,</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rates&#39;</span><span class="p">][</span><span class="s1">&#39;ioniz&#39;</span><span class="p">][</span><span class="s1">&#39;ionization&#39;</span><span class="p">][</span><span class="n">levels_to_keep</span><span class="p">,</span><span class="n">m</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkl,jmkl-&gt;imkl&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr_red_inv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span>
                                                             <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),:,:],</span>
                        <span class="n">recomb_coeff</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]):</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]),</span><span class="n">metasplus_to_keep</span><span class="p">,:,:])</span>
                        <span class="p">)</span></div>

<div class="viewcode-block" id="colradpy.solve_time_dependent"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.solve_time_dependent">[docs]</a>    <span class="k">def</span> <span class="nf">solve_time_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will solve the CR matrix with no assumptions. A matrix expoential is used to solve this problem.</span>
<span class="sd">           A source term can be included to mimick erosion of fresh atoms or injection of neutral gas or maybe even LIF</span>

<span class="sd">           Uses same CR matrix &quot;.data[&#39;cr_matrix&#39;][&#39;cr&#39;]&quot; used to define the reduced CR matrix that the quasistatic solution solves.</span>
<span class="sd">           </span>
<span class="sd">           Creates a new dictionary under [&#39;processed&#39;] call [&#39;td&#39;]</span>
<span class="sd">           Stores eigenvalues and eigenvectors that were required for the solution (Theres also physics there see ColRadPy paper).</span>
<span class="sd">           Stores the time changing populations.</span>
<span class="sd">        </span>
<span class="sd">           R. LeVeque, Finite Difference Methods for Ordinary and Par-</span>
<span class="sd">           tial Differential Equations: Steady-State and Time-Dependent</span>
<span class="sd">           Problems (Classics in Applied Mathematics Classics in Applied</span>
<span class="sd">           Mathemat), Society for Industrial and Applied Mathematics,</span>
<span class="sd">           Philadelphia, PA, USA, 2007.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;processed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#check if a source term has been provided, if a source term has been provided solve the problem with s asource</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="c1">#solve the matrix with a source term</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;td_pop&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;eigenvals&#39;</span><span class="p">],</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;eigenvectors&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="n">solve_matrix_exponential_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_n0&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_source&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_t&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#no source term was provided solve just the normal matrix</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;td_pop&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;eigenvals&#39;</span><span class="p">],</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;td&#39;</span><span class="p">][</span><span class="s1">&#39;eigenvectors&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">solve_matrix_exponential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_matrix&#39;</span><span class="p">][</span><span class="s1">&#39;cr&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_n0&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;td_t&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="colradpy.split_pec_multiplet"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.split_pec_multiplet">[docs]</a>    <span class="k">def</span> <span class="nf">split_pec_multiplet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will solve take LS resolved PECs and split them statistically among the j levels</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;processed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_quasi_static</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;j_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;j_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;relative_inten&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">])):</span>
            <span class="n">up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pec_levels&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">ju</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">split_multiplet</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">][</span><span class="n">up</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">][</span><span class="n">up</span><span class="p">],</span>
                                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">][</span><span class="n">low</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">][</span><span class="n">low</span><span class="p">])</span>
            <span class="n">L_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ju</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;j_low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;j_up&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ju</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;relative_inten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            
            <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,l-&gt;lijk&#39;</span><span class="p">,</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                                         <span class="n">res</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;split&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span></div>
        
<div class="viewcode-block" id="colradpy.solve_cr"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.solve_cr">[docs]</a>    <span class="k">def</span> <span class="nf">solve_cr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve_cr automates the calls to various function to make the data for</span>
<span class="sd">           need to solve the CR equations and get to the quanties that users want.</span>
<span class="sd">           This can be thought of as a basic mode for the user doesn&#39;t want to mess</span>
<span class="sd">           with the default rates that are made.</span>

<span class="sd">           Generally what a user just wanting basic output should use.</span>
<span class="sd">           Makes ionization if requested</span>
<span class="sd">           Makes recombination if requested</span>
<span class="sd">           Makes excitation rates</span>
<span class="sd">           Populates the CR matrix</span>
<span class="sd">           Solve the CR matrix using the quasistatic approximation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_ionization&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_ioniz_from_reduced_ionizrates</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;suppliment_with_ecip&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_ecip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suppliment_with_ecip</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_recombination_rates_from_file</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;use_recombination_three_body&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_three_body_recombination</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_electron_excitation_rates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_cr_matrix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_quasi_static</span><span class="p">()</span></div>

<div class="viewcode-block" id="colradpy.plot_pec_sticks"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.plot_pec_sticks">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pec_sticks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dens</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">meta</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;plot_pec_sticks will plot the the PEC values versus wavelength.</span>
<span class="sd">           **WARNING** wavelngth values will be wrong unless energy levels in the file</span>
<span class="sd">           have been &#39;shifted&#39; to NIST values.</span>
<span class="sd">           User provides index arrays for the temperature density and metastable</span>
<span class="sd">           for the PECs to be plotted.</span>
<span class="sd">           </span>
<span class="sd">        :param temp: Array of temperature indexes</span>
<span class="sd">        :type temp: int array</span>

<span class="sd">        :param dens: Array of density indexes</span>
<span class="sd">        :type dens: int array</span>

<span class="sd">        :param meta: array of metastable indexes</span>
<span class="sd">        :type metas: int array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;processed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_cr</span><span class="p">()</span>

        
        <span class="n">p_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]))</span>
        <span class="n">p_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]))</span>
        <span class="n">p_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_t</span> <span class="o">=</span> <span class="n">p_t</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_n</span> <span class="o">=</span> <span class="n">p_n</span><span class="p">[</span><span class="n">dens</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_m</span> <span class="o">=</span> <span class="n">p_m</span><span class="p">[</span><span class="n">meta</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p_n</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">p_t</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_m</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">],</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">]),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][:,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength in air (nm)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PEC (ph cm$^{-1}$ s$^{-1}$)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Temperature &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; eV,  &#39;</span><span class="o">+</span>\
                              <span class="s1">&#39;Density &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;.2e&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; cm$^{-3}$, &#39;</span><span class="o">+</span>\
                              <span class="s1">&#39;Metastable &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1300</span><span class="p">)</span></div>

<div class="viewcode-block" id="colradpy.plot_pec_ratio_temp"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.plot_pec_ratio_temp">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pec_ratio_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pec1</span><span class="p">,</span><span class="n">pec2</span><span class="p">,</span><span class="n">dens</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span><span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])):</span>
        <span class="sd">&quot;&quot;&quot;plot_pec_ratio_temp will plot the ratio of any two user defined PECs versus temperature.</span>
<span class="sd">           Density values for the ratio are choosen by the user by specifying the indices from the user</span>
<span class="sd">           density array to be plot. Each density chosen will show up as a new line in the figure.</span>
<span class="sd">           The user can also choose the metastable by default only the ground is plotted.</span>
<span class="sd">           The user specifies the indices of the metastable to be plot. </span>
<span class="sd">           A new figure for each metastable chosen will be made with the number of density lines chosen.</span>

<span class="sd">        :param pec1: Index of pec on the top of the ratio</span>
<span class="sd">        :type pec1: int</span>

<span class="sd">        :param pec2: Index of the pec on the bottom of the ratio</span>
<span class="sd">        :type pec2: int</span>

<span class="sd">        :param dens: Array of density indexes</span>
<span class="sd">        :type dens: int array</span>

<span class="sd">        :param meta: array of metastable indexes</span>
<span class="sd">        :type metas: int array</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;processed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_cr</span><span class="p">()</span>

        
        <span class="n">dens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>
        <span class="n">p_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">p_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_n</span> <span class="o">=</span> <span class="n">p_n</span><span class="p">[</span><span class="n">dens</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_m</span> <span class="o">=</span> <span class="n">p_m</span><span class="p">[</span><span class="n">meta</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_m</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>                        
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p_n</span><span class="p">:</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">pec1</span><span class="p">,</span><span class="n">k</span><span class="p">,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">pec2</span><span class="p">,</span><span class="n">k</span><span class="p">,:,</span><span class="n">i</span><span class="p">],</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$n_e$ = &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;.1e&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; cm$^{-3}$&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature (eV)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio (-)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ratio of PEC &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pec1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">][</span><span class="n">pec1</span><span class="p">],</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; nm&#39;</span><span class="o">+</span>\
                          <span class="s1">&#39; to PEC &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pec2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">][</span><span class="n">pec2</span><span class="p">],</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; nm, &#39;</span><span class="o">+</span>\
                              <span class="s1">&#39;Metastable &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="colradpy.plot_pec_ratio_dens"><a class="viewcode-back" href="../colradpy_class.html#colradpy_class.colradpy.plot_pec_ratio_dens">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pec_ratio_dens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pec1</span><span class="p">,</span><span class="n">pec2</span><span class="p">,</span><span class="n">temp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span><span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span><span class="n">scale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;plot_pec_ratio_dens will plot the ratio of any two user defined PECs versus density.</span>
<span class="sd">           Temperature values for the ratio are choosen by the user by specifying the indices from the user</span>
<span class="sd">           temperature array to be plotted. Each temperature chosen will show up as a new line in the figure.</span>
<span class="sd">           The user can also choose the metastable by default only the ground is plotted.</span>
<span class="sd">           The user specifies the indices of the metastable to be plot. </span>
<span class="sd">           A new figure for each metastable chosen will be made with the number of density lines chosen.</span>
<span class="sd">           The density axis default is a log scale but linear can be chosen as well.</span>
<span class="sd">        :param pec1: Index of pec on the top of the ratio</span>
<span class="sd">        :type pec1: int</span>

<span class="sd">        :param pec2: Index of the pec on the bottom of the ratio</span>
<span class="sd">        :type pec2: int</span>

<span class="sd">        :param temp: Array of temperature indexes</span>
<span class="sd">        :type temp: int array</span>

<span class="sd">        :param meta: array of metastable indexes</span>
<span class="sd">        :type metas: int array</span>

<span class="sd">        :param scale: scale for the density axis default is log</span>
<span class="sd">        :type scale: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">p_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">p_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_n</span> <span class="o">=</span> <span class="n">p_n</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">p_m</span> <span class="o">=</span> <span class="n">p_m</span><span class="p">[</span><span class="n">meta</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_m</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>                        
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p_n</span><span class="p">:</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;dens_grid&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">pec1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">pec2</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,:],</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T_e$ = &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;temp_grid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;.1f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; eV&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Density (cm$^{-3}$)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio (-)&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ratio of PEC &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pec1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">][</span><span class="n">pec1</span><span class="p">],</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; nm&#39;</span><span class="o">+</span>\
                          <span class="s1">&#39; to PEC &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pec2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_air&#39;</span><span class="p">][</span><span class="n">pec2</span><span class="p">],</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; nm, &#39;</span><span class="o">+</span>\
                              <span class="s1">&#39;Metastable &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atomic&#39;</span><span class="p">][</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                <span class="k">if</span><span class="p">(</span><span class="n">scale</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span></div></div>



</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ColRadPy 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Curtis Johnson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>